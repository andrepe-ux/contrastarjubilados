<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Jubilaciones - ProyecciÃ³n</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
.cross-table th, .cross-table td { text-align:center; white-space: nowrap; }
.sticky-col th:first-child, .sticky-col td:first-child { position: sticky; left: 0; background-color: #f0f0f0; z-index: 10; }
canvas { max-height: 300px; }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<div class="flex-1 max-w-7xl mx-auto bg-white rounded-2xl shadow p-6 my-8 space-y-8">
    <h1 class="text-3xl font-extrabold text-center text-gray-800">ğŸ“Š InformaciÃ³n Jubilaciones</h1>

    <div id="dropArea" class="border-4 border-dashed border-blue-400 rounded-xl p-8 text-center cursor-pointer text-gray-600 hover:bg-blue-50 relative transition duration-300">
        <p class="text-lg font-semibold">Arrastra tu archivo Excel (.xlsx) aquÃ­ o haz clic para seleccionarlo.</p>
        <input type="file" id="fileInput" accept=".xlsx" class="hidden">
        <div id="fileLoadedMessage" class="text-green-700 font-bold mt-3 hidden">âœ… Archivo cargado y datos procesados.</div>
        <div id="loadingExcel" class="absolute inset-0 bg-white/70 flex items-center justify-center hidden">
          <div class="text-xl font-bold">Procesando datos... â³</div>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-6 gap-6 mt-4 p-4 border rounded-xl bg-yellow-50">
        <div>
            <label class="block text-sm font-medium text-gray-700">Edad JubilaciÃ³n</label>
            <input type="number" id="inputYears" value="65" min="0" class="border border-yellow-300 rounded px-3 py-2 w-full" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Meses adicionales</label>
            <input type="number" id="inputMonths" value="0" min="0" max="11" class="border border-yellow-300 rounded px-3 py-2 w-full" />
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Filtro Provincia</label>
            <select id="filterProvincia" class="border border-yellow-300 rounded px-3 py-2 w-full"><option value="">Todas</option></select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Filtro Zona RRHH</label>
            <select id="filterRRHH" class="border border-yellow-300 rounded px-3 py-2 w-full"><option value="">Todas</option></select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Filtro Gerente RRHH</label>
            <select id="filterGerente" class="border border-yellow-300 rounded px-3 py-2 w-full"><option value="">Todos</option></select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Agrupar por</label>
            <select id="groupingType" class="border border-yellow-300 rounded px-3 py-2 w-full">
                <option value="departamento">Departamento</option>
                <option value="provincia">Provincia</option>
            </select>
            <p class="text-[10px] text-red-500 mt-1 italic leading-tight">* Nota: Si el Excel es de ESP, cambiar a provincia.</p>
        </div>
    </div>

    <div class="flex justify-end items-center gap-4 bg-gray-50 p-4 rounded-xl border">
        <span class="text-sm font-bold text-gray-700">VisualizaciÃ³n:</span>
        <select id="chartStyle" class="border border-gray-300 rounded px-3 py-1 bg-white">
            <option value="bar">Barras</option>
            <option value="line">LÃ­neas</option>
        </select>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 mt-8">
        <div class="bg-white p-5 rounded-xl shadow border flex flex-col h-[400px]">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold">ğŸ—“ï¸ PrevisiÃ³n por AÃ±o</h2>
                <button onclick="downloadChart('chartYear', 'jubilaciones_por_ano')" class="text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded">ğŸ“¸ Exportar PNG</button>
            </div>
            <canvas id="chartYear"></canvas>
        </div>
        <div class="bg-white p-5 rounded-xl shadow border flex flex-col h-[400px]">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold" id="titleDept">ğŸ¢ Por Departamento</h2>
                <button onclick="downloadChart('chartDept', 'jubilaciones_por_dept')" class="text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded">ğŸ“¸ Exportar PNG</button>
            </div>
            <canvas id="chartDept"></canvas>
        </div>
        <div class="bg-white p-5 rounded-xl shadow border flex flex-col h-[400px]">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold">ğŸ§‘â€ğŸ’¼ Por Zona RRHH</h2>
                <button onclick="downloadChart('chartRRHH', 'jubilaciones_por_rrhh')" class="text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded">ğŸ“¸ Exportar PNG</button>
            </div>
            <canvas id="chartRRHH"></canvas>
        </div>
        <div class="bg-white p-5 rounded-xl shadow border flex flex-col h-[400px]">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold">ğŸ‘¨â€ğŸ’¼ Por Gerente RRHH</h2>
                <button onclick="downloadChart('chartGerente', 'jubilaciones_por_gerente')" class="text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded">ğŸ“¸ Exportar PNG</button>
            </div>
            <canvas id="chartGerente"></canvas>
        </div>
    </div>

    <div class="space-y-10">
        <div class="bg-white p-5 rounded-xl shadow border">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">ğŸ“… Detalle 10 aÃ±os: Departamento / Provincia</h2>
            <div class="overflow-x-auto"><table id="tableDept" class="min-w-full cross-table sticky-col border text-sm"></table></div>
        </div>
        <div class="bg-white p-5 rounded-xl shadow border">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">ğŸ“… Detalle 10 anos: Zona RRHH</h2>
            <div class="overflow-x-auto"><table id="tableRRHH" class="min-w-full cross-table sticky-col border text-sm"></table></div>
        </div>
        <div class="bg-white p-5 rounded-xl shadow border">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">ğŸ“… Detalle 10 anos: Gerente RRHH</h2>
            <div class="overflow-x-auto"><table id="tableGerente" class="min-w-full cross-table sticky-col border text-sm"></table></div>
        </div>
    </div>

    <div class="mt-12 flex gap-4 flex-wrap pb-10 justify-center">
        <button id="exportExcel" class="bg-green-700 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-800 transition shadow-lg transform hover:scale-105">ğŸ“Š EXPORTAR TODO A EXCEL</button>
        <button id="exportFiltered" class="bg-blue-700 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-800 transition shadow-lg transform hover:scale-105">ğŸ” EXPORTAR FILTRADO A EXCEL</button>
    </div>
</div>

<footer class="bg-gray-800 text-white text-center py-2 mt-auto text-sm">Ãrea ContrataciÃ³n y Movimientos SH @ 2025</footer>

<script>
let dataRows=[];
let charts={};
const ANOS_PREVISAO=10;

// Elementos Globales
const elements = {
    dropArea: document.getElementById('dropArea'),
    fileInput: document.getElementById('fileInput'),
    fileLoadedMessage: document.getElementById('fileLoadedMessage'),
    loadingExcel: document.getElementById('loadingExcel'),
    inputYears: document.getElementById('inputYears'),
    inputMonths: document.getElementById('inputMonths'),
    groupingType: document.getElementById('groupingType'),
    chartStyle: document.getElementById('chartStyle'),
    filterProvincia: document.getElementById('filterProvincia'),
    filterRRHH: document.getElementById('filterRRHH'),
    filterGerente: document.getElementById('filterGerente'),
    tableDept: document.getElementById('tableDept'),
    tableRRHH: document.getElementById('tableRRHH'),
    tableGerente: document.getElementById('tableGerente'),
    titleDept: document.getElementById('titleDept')
};

function parseDate(v){
  if(v instanceof Date) return v;
  if(typeof v==='number'){const d=XLSX.SSF.parse_date_code(v); return new Date(d.y,d.m-1,d.d);}
  const d=new Date(v); return isNaN(d)?null:d;
}

function drawChart(id, label, data, color='rgba(59, 130, 246, 0.7)'){
  const type = elements.chartStyle.value;
  if(charts[id]) charts[id].destroy();
  const keys = Object.keys(data).sort();
  const vals = keys.map(k => data[k]);

  charts[id] = new Chart(document.getElementById(id), {
    type: type,
    data: {
      labels: keys,
      datasets: [{
        label: label,
        data: vals,
        backgroundColor: color,
        borderColor: color.replace('0.7', '1'),
        borderWidth: 2,
        tension: 0.3,
        fill: type === 'line' ? false : true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    }
  });
}

function downloadChart(id, name) {
    const canvas = document.getElementById(id);
    const link = document.createElement('a');
    link.download = `${name}.png`;
    link.href = canvas.toDataURL('image/png', 1.0);
    link.click();
}

function applyFilters(rows){
  return rows.filter(r=>{
    return (!elements.filterProvincia.value || r.provincia===elements.filterProvincia.value) &&
           (!elements.filterRRHH.value || r.zonaRRHH===elements.filterRRHH.value) &&
           (!elements.filterGerente.value || r.gerente===elements.filterGerente.value);
  });
}

function computeData(){
  if(!dataRows.length) return;
  const rows = applyFilters(dataRows);
  const yearNow = new Date().getFullYear();
  const distYear={}, distDept={}, distRRHH={}, distGerente={};
  const crossDept={}, crossRRHH={}, crossGerente={};

  const age = parseInt(elements.inputYears.value)||65;
  const months = parseInt(elements.inputMonths.value)||0;

  rows.forEach(r=>{
    const d=parseDate(r.fechaNacimiento); if(!d) return;
    const jubYear=d.getFullYear()+age+Math.floor(months/12);
    if(jubYear < yearNow) return;

    distYear[jubYear]=(distYear[jubYear]||0)+1;

    const keyDept = elements.groupingType.value==='provincia' ? r.provincia : r.departamento;
    if(keyDept){
      distDept[keyDept]=(distDept[keyDept]||0)+1;
      crossDept[keyDept]=crossDept[keyDept]||{};
      if(jubYear < yearNow+ANOS_PREVISAO) crossDept[keyDept][jubYear]=(crossDept[keyDept][jubYear]||0)+1;
    }

    if(r.zonaRRHH){
      distRRHH[r.zonaRRHH]=(distRRHH[r.zonaRRHH]||0)+1;
      crossRRHH[r.zonaRRHH]=crossRRHH[r.zonaRRHH]||{};
      if(jubYear < yearNow+ANOS_PREVISAO) crossRRHH[r.zonaRRHH][jubYear]=(crossRRHH[r.zonaRRHH][jubYear]||0)+1;
    }

    if(r.gerente){
      distGerente[r.gerente]=(distGerente[r.gerente]||0)+1;
      crossGerente[r.gerente]=crossGerente[r.gerente]||{};
      if(jubYear < yearNow+ANOS_PREVISAO) crossGerente[r.gerente][jubYear]=(crossGerente[r.gerente][jubYear]||0)+1;
    }
  });

  elements.titleDept.innerText = elements.groupingType.value==='provincia' ? 'ğŸ¢ Por Provincia' : 'ğŸ¢ Por Departamento';

  drawChart('chartYear', 'Total Jubilaciones', distYear, 'rgba(16, 185, 129, 0.7)');
  drawChart('chartDept', elements.groupingType.value==='provincia'?'Provincia':'Departamento', distDept, 'rgba(220, 38, 38, 0.7)');
  drawChart('chartRRHH', 'Zona RRHH', distRRHH, 'rgba(59, 130, 246, 0.7)');
  drawChart('chartGerente', 'Gerente', distGerente, 'rgba(234, 179, 8, 0.7)');

  renderTable(crossDept, elements.tableDept, yearNow);
  renderTable(crossRRHH, elements.tableRRHH, yearNow);
  renderTable(crossGerente, elements.tableGerente, yearNow);
}

function renderTable(data, table, yearNow){
  const years=[];
  for(let y=yearNow; y<yearNow+ANOS_PREVISAO; y++) years.push(y);
  let html='<thead><tr class="bg-gray-100"><th class="border px-4 py-2 sticky left-0 bg-gray-200">ClasificaciÃ³n</th>';
  years.forEach(y=>html+=`<th class="border px-4 py-2">${y}</th>`);
  html+='<th class="border px-4 py-2 bg-indigo-200 font-bold">Total</th></tr></thead><tbody>';
  
  Object.keys(data).sort().forEach(k=>{
    let total=0;
    html+=`<tr><td class="border px-4 py-2 sticky left-0 bg-white font-medium">${k}</td>`;
    years.forEach(y=>{const v=data[k][y]||0; html+=`<td class="border px-4 py-2">${v}</td>`; total+=v;});
    html+=`<td class="border px-4 py-2 bg-indigo-50 font-bold">${total}</td></tr>`;
  });
  html+='</tbody>'; table.innerHTML=html;
}

// Drag & Drop
elements.dropArea.addEventListener('click',()=>elements.fileInput.click());
elements.dropArea.addEventListener('dragover',e=>{e.preventDefault(); elements.dropArea.classList.add('bg-blue-100');});
elements.dropArea.addEventListener('dragleave',e=>{e.preventDefault(); elements.dropArea.classList.remove('bg-blue-100');});
elements.dropArea.addEventListener('drop',e=>{
    e.preventDefault(); 
    elements.dropArea.classList.remove('bg-blue-100'); 
    if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
elements.fileInput.addEventListener('change',e=>{if(e.target.files.length) handleFile(e.target.files[0]);});

function handleFile(file){
  if(!file) return;
  elements.loadingExcel.classList.remove('hidden');
  const reader=new FileReader();
  reader.onload=ev=>{
    const data=new Uint8Array(ev.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    if(!rows.length){alert("Archivo vacÃ­o"); elements.loadingExcel.classList.add('hidden'); return;}
    
    const h=Object.keys(rows[0]).map(x=>x.toLowerCase().trim());
    const findCol=(keywords)=>{for(const k of keywords){const found=h.find(x=>x.includes(k)); if(found) return Object.keys(rows[0]).find(kk=>kk.toLowerCase().trim()===found);} return null;}
    
    const colN=findCol(['nascimento','nacimiento','birth','fecha']);
    const colD=findCol(['departamento','dept','dep']);
    const colP=findCol(['provincia','centro','ciudad']);
    const colRRHH=findCol(['zona rrhh','zona','rrhh']);
    const colG=findCol(['gerente','manager','seleccion']);

    if(!colN){alert("Error: No se encontrÃ³ la columna de Fecha de Nacimiento"); elements.loadingExcel.classList.add('hidden'); return;}

    dataRows=rows.map(r=>({
      fechaNacimiento: r[colN],
      departamento: r[colD]||'Sin Departamento',
      provincia: r[colP]||'Sin Provincia',
      zonaRRHH: r[colRRHH]||'Sin Zona',
      gerente: r[colG]||'Sin Gerente'
    }));

    const fillFilter = (select, key) => {
        const values = [...new Set(dataRows.map(r=>r[key]))].sort();
        select.innerHTML='<option value="">' + (select.id.includes('Gerente') ? 'Todos' : 'Todas') + '</option>' + 
                         values.map(v=>`<option value="${v}">${v}</option>`).join('');
    };
    fillFilter(elements.filterProvincia, 'provincia');
    fillFilter(elements.filterRRHH, 'zonaRRHH');
    fillFilter(elements.filterGerente, 'gerente');

    elements.fileLoadedMessage.classList.remove('hidden');
    computeData();
    elements.loadingExcel.classList.add('hidden');
  };
  reader.readAsArrayBuffer(file);
}

// Re-computar ante cambios
[elements.inputYears, elements.inputMonths, elements.groupingType, elements.chartStyle, elements.filterProvincia, elements.filterRRHH, elements.filterGerente].forEach(el=>{
  el.addEventListener('change', computeData);
});

// EXPORTACIÃ“N A EXCEL (Con pestaÃ±a de aÃ±os)
function exportExcel(filtered=false){
  if(!dataRows.length){alert("Carga datos primero."); return;}
  const wb=XLSX.utils.book_new();
  const rowsToProcess = filtered ? applyFilters(dataRows) : dataRows;
  const yearNow = new Date().getFullYear();
  const age = parseInt(elements.inputYears.value)||65;
  const months = parseInt(elements.inputMonths.value)||0;

  // 1. Hoja de Resumen por AÃ±os
  const yearSummary = {};
  rowsToProcess.forEach(r => {
      const d = parseDate(r.fechaNacimiento); if(!d) return;
      const y = d.getFullYear() + age + Math.floor(months/12);
      if(y >= yearNow) yearSummary[y] = (yearSummary[y]||0)+1;
  });
  const yearData = Object.keys(yearSummary).sort().map(y => ({ "AÃ±o": y, "Jubilaciones": yearSummary[y] }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(yearData), "Resumen_Anual");

  // 2. FunciÃ³n para crear hojas de tablas cruzadas
  function createSheetData(typeKey){
      const cross = {};
      rowsToProcess.forEach(r => {
          const d = parseDate(r.fechaNacimiento); if(!d) return;
          const jubYear = d.getFullYear()+age+Math.floor(months/12);
          if(jubYear < yearNow) return;
          const key = (typeKey === 'dept_prov') ? (elements.groupingType.value==='provincia' ? r.provincia : r.departamento) : r[typeKey];
          if(!key) return;
          cross[key] = cross[key] || {};
          if(jubYear < yearNow + ANOS_PREVISAO) cross[key][jubYear] = (cross[key][jubYear]||0)+1;
      });
      const sheetRows = [];
      const years = Array.from({length: ANOS_PREVISAO}, (_, i) => yearNow + i);
      Object.keys(cross).sort().forEach(k => {
          const row = { "Clave": k };
          let total = 0;
          years.forEach(y => { row[y] = cross[k][y]||0; total += row[y]; });
          row["Total_10_AÃ±os"] = total;
          sheetRows.push(row);
      });
      return XLSX.utils.json_to_sheet(sheetRows);
  }

  XLSX.utils.book_append_sheet(wb, createSheetData('dept_prov'), "Por_Dept_Prov");
  XLSX.utils.book_append_sheet(wb, createSheetData('zonaRRHH'), "Por_Zona_RRHH");
  XLSX.utils.book_append_sheet(wb, createSheetData('gerente'), "Por_Gerente");

  XLSX.writeFile(wb, filtered ? 'Prevision_Jubilacion_Filtrada.xlsx' : 'Prevision_Jubilacion_Total.xlsx');
}

document.getElementById('exportExcel').addEventListener('click',()=>exportExcel(false));
document.getElementById('exportFiltered').addEventListener('click',()=>exportExcel(true));
</script>

</body>
</html>