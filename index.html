<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Edades y Jubilaciones</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Estilo para asegurar que los elementos se mantengan alineados y visibles */
    .cross-table th, .cross-table td {
      white-space: nowrap;
      text-align: center;
    }
    /* Estilo para fijar la primera columna en las tablas cruzadas */
    .sticky-col th:first-child, .sticky-col td:first-child {
      position: sticky;
      left: 0;
      z-index: 10;
      background-color: inherit;
    }
    .sticky-col td:first-child {
      background-color: white; 
    }
    .sticky-col th:first-child {
      z-index: 20;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<div class="flex-1 max-w-7xl mx-auto bg-white rounded-2xl shadow p-6 space-y-8 w-full">
  <h1 class="text-3xl font-extrabold text-center text-gray-800">üìä Dashboard de Edades y Jubilaciones</h1>

  <div id="dropArea" class="border-4 border-dashed border-blue-400 rounded-xl p-8 text-center cursor-pointer text-gray-600 hover:bg-blue-50 relative transition duration-300">
    <p class="text-lg font-semibold">Arrastra tu archivo Excel (.xlsx) aqu√≠ o haz clic para seleccionarlo.</p>
    <p class="text-sm mt-1">El archivo debe contener al menos una columna de **Fecha de Nacimiento**.</p>
    <input type="file" id="fileInput" accept=".xlsx" class="hidden" />
    <div id="loadingIndicator" class="absolute inset-0 bg-blue-600 bg-opacity-80 flex items-center justify-center hidden rounded-xl">
      <div class="bg-white p-5 rounded-lg shadow-2xl w-full max-w-sm">
        <p id="loadingMessage" class="font-bold text-lg text-gray-800 mb-3">Cargando archivo...</p>
        <div class="w-full bg-gray-200 rounded-full h-3.5">
          <div id="progressBar" class="bg-green-500 h-3.5 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>
      </div>
    </div>
    <p id="fileLoadedMessage" class="text-green-700 font-bold mt-3 hidden">‚úÖ Archivo cargado y datos procesados.</p>
  </div>
  
  <div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mt-4 p-4 border rounded-xl bg-yellow-50">
    <div>
      <label class="block text-sm font-medium text-gray-700">Edad de Jubilaci√≥n (a√±os)</label>
      <input type="number" id="inputYears" value="65" min="0" class="border border-yellow-300 rounded px-3 py-2 w-full focus:ring-yellow-500 focus:border-yellow-500" />
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Meses adicionales</label>
      <input type="number" id="inputMonths" value="0" min="0" max="11" class="border border-yellow-300 rounded px-3 py-2 w-full focus:ring-yellow-500 focus:border-yellow-500" />
    </div>
    <div class="col-span-2">
      <label class="block text-sm font-medium text-gray-700">Agrupar Jubilaciones por</label>
      <select id="groupingType" class="border border-yellow-300 rounded px-3 py-2 w-full focus:ring-yellow-500 focus:border-yellow-500">
        <option value="departamento">Departamento</option>
        <option value="provincia">Provincia</option>
      </select>
    </div>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 mt-8">
    
    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 h-full flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-700">üë§ Distribuci√≥n de Edades</h2>
        <select id="chartTypeAge" class="border border-gray-300 rounded px-2 py-1 text-sm">
          <option value="bar">Barras</option>
          <option value="line">L√≠neas</option>
        </select>
      </div>
      <div class="flex-grow">
        <canvas id="ageChart"></canvas>
      </div>
      <button id="exportAgePNG" data-chart-id="ageChart" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-150">Exportar Edad PNG</button>
    </div>

    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 h-full flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-700">üóìÔ∏è Previsi√≥n de Jubilaciones por A√±o</h2>
        <select id="chartTypeRetirement" class="border border-gray-300 rounded px-2 py-1 text-sm">
          <option value="bar">Barras</option>
          <option value="line">L√≠neas</option>
        </select>
      </div>
      <div class="flex-grow">
        <canvas id="retirementChart"></canvas>
      </div>
      <button id="exportRetirementPNG" data-chart-id="retirementChart" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-150">Exportar Jubilaciones A√±o PNG</button>
    </div>

    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 h-full flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-700">‚è±Ô∏è Jubilaciones en Intervalos de 5 a√±os (Total)</h2>
        <select id="chartTypeInterval" class="border border-gray-300 rounded px-2 py-1 text-sm">
          <option value="bar">Barras</option>
          <option value="line">L√≠neas</option>
        </select>
      </div>
      <div class="flex-grow">
        <canvas id="intervalChart"></canvas>
      </div>
      <button id="exportIntervalPNG" data-chart-id="intervalChart" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-150">Exportar Intervalos PNG</button>
    </div>

    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200 h-full flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 id="deptChartTitle" class="text-xl font-bold text-gray-700">üè¢ Jubilaciones por Departamento</h2>
        <select id="chartTypeDept" class="border border-gray-300 rounded px-2 py-1 text-sm">
          <option value="bar">Barras</option>
          <option value="line">L√≠neas</option>
        </select>
      </div>
      <div class="flex-grow">
        <canvas id="deptChart"></canvas>
      </div>
      <button id="exportDeptPNG" data-chart-id="deptChart" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-150">Exportar Agrupaci√≥n PNG</button>
    </div>
  </div>
  
  <div class="mt-10 p-5 bg-white rounded-xl shadow-lg border border-gray-200">
    <h2 id="yearlyCrossTableTitle" class="text-xl font-bold text-gray-700 mb-4">üìÖ Jubilaciones por Agrupaci√≥n vs. Pr√≥ximos 10 A√±os</h2>
    <div class="overflow-x-auto border rounded-lg shadow-md max-h-96">
      <table class="min-w-full text-sm cross-table sticky-col bg-white">
        <thead class="bg-gray-100 sticky top-0">
          <tr id="yearlyCrossTableHead"></tr>
        </thead>
        <tbody id="yearlyCrossTableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="mt-10 p-5 bg-white rounded-xl shadow-lg border border-gray-200">
    <h2 id="crossTableTitle" class="text-xl font-bold text-gray-700 mb-4">üóÇÔ∏è Jubilaciones por Agrupaci√≥n vs. Intervalos de 5 a√±os</h2>
    <div class="overflow-x-auto border rounded-lg shadow-md max-h-96">
      <table class="min-w-full text-sm cross-table sticky-col bg-white">
        <thead class="bg-gray-100 sticky top-0">
          <tr id="crossTableHead"></tr>
        </thead>
        <tbody id="crossTableBody"></tbody>
      </table>
    </div>
  </div>
  
  <div class="p-5 border-t border-gray-200 mt-8 space-y-4">
    <div class="flex flex-col sm:flex-row items-center gap-4">
      <label for="yearSelect" class="font-semibold text-gray-700 min-w-[150px]">Exportar por <span class="text-green-600">A√±o de Jubilaci√≥n</span>:</label>
      <select id="yearSelect" class="border border-gray-300 rounded px-3 py-2 flex-grow"></select>
      <button id="exportBtn" class="bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 transition duration-150 w-full sm:w-auto">Exportar a Excel (A√±o)</button>
      <button id="exportPDF" class="bg-red-600 text-white px-6 py-2 rounded-xl hover:bg-red-700 transition duration-150 w-full sm:w-auto">Exportar Dashboard a PDF</button>
    </div>
    
    <div class="flex flex-col sm:flex-row items-center gap-4 border-t pt-4">
      <label id="agrupacionExportLabel" for="agrupacionSelect" class="font-semibold text-gray-700 min-w-[150px]">Exportar por <span class="text-blue-600">Departamento</span>:</label>
      <select id="agrupacionSelect" class="border border-gray-300 rounded px-3 py-2 flex-grow"></select>
      <button id="exportAgrupacionBtn" class="bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700 transition duration-150 w-full sm:w-auto">Exportar a Excel (Agrupaci√≥n)</button>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6 p-5 bg-white rounded-xl shadow-lg border border-gray-200">
    <div class="overflow-x-auto">
      <h2 class="text-lg font-semibold mb-3 text-gray-700">üìù Tabla: Jubilaciones por A√±o</h2>
      <table class="min-w-full border text-sm shadow-md">
        <thead class="bg-gray-100">
          <tr><th class="border px-3 py-2 text-left">A√±o</th><th class="border px-3 py-2">Total</th></tr>
        </thead>
        <tbody id="yearTable"></tbody>
      </table>
    </div>
    <div class="overflow-x-auto">
      <h2 id="deptTableTitle" class="text-lg font-semibold mb-3 text-gray-700">üìù Tabla: Jubilaciones por Departamento</h2>
      <table class="min-w-full border text-sm shadow-md">
        <thead class="bg-gray-100">
          <tr><th id="deptTableHead" class="border px-3 py-2 text-left">Departamento</th><th class="border px-3 py-2">Total</th></tr>
        </thead>
        <tbody id="deptTable"></tbody>
      </table>
    </div>
  </div>

</div>

<footer class="bg-gray-800 text-white text-center py-4 mt-auto text-sm">√Årea Contrataci√≥n y Movimientos SH @ 2025</footer>

<script>
const INTERVALO = 5;
const ANOS_PREVISAO = 10; 
let trabalhadoresPorAno = {};
let trabalhadoresPorAgrupacion = {};
let dataRows = [];
let charts = {};

// Referencias a DOM
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const loadingIndicator = document.getElementById('loadingIndicator');
const progressBar = document.getElementById('progressBar');
const loadingMessage = document.getElementById('loadingMessage');
const fileLoadedMessage = document.getElementById('fileLoadedMessage');

const inputYears = document.getElementById('inputYears');
const inputMonths = document.getElementById('inputMonths');
const groupingType = document.getElementById('groupingType');

const yearSelect = document.getElementById('yearSelect');
const agrupacionSelect = document.getElementById('agrupacionSelect');
const agrupacionExportLabel = document.getElementById('agrupacionExportLabel');
const exportBtn = document.getElementById('exportBtn');
const exportAgrupacionBtn = document.getElementById('exportAgrupacionBtn');
const exportPDF = document.getElementById('exportPDF');

const deptChartTitle = document.getElementById('deptChartTitle');
const deptTableTitle = document.getElementById('deptTableTitle');
const deptTableHead = document.getElementById('deptTableHead');
const crossTableTitle = document.getElementById('crossTableTitle');
const crossTableHead = document.getElementById('crossTableHead');
const crossTableBody = document.getElementById('crossTableBody');

const yearlyCrossTableTitle = document.getElementById('yearlyCrossTableTitle');
const yearlyCrossTableHead = document.getElementById('yearlyCrossTableHead');
const yearlyCrossTableBody = document.getElementById('yearlyCrossTableBody');


/**
 * Intenta convertir un valor de celda de Excel a una fecha.
 */
function parseData(v) {
  if (v instanceof Date) return v;
  if (typeof v === 'number') {
    const date = XLSX.SSF.parse_date_code(v);
    if (date.y >= 1900 && date.y <= 2100) {  
        return new Date(date.y, date.m - 1, date.d);
    }
  }
  if (typeof v === 'string') {
    let d = new Date(v);
    if (!isNaN(d)) return d;
    const m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (m) {
        d = new Date(m[3], m[2] - 1, m[1]); 
        if (!isNaN(d)) return d;
    }
  }
  return null;
}

/**
 * Calcula la edad exacta de una persona.
 */
function idade(d) {
  const h = new Date();
  let i = h.getFullYear() - d.getFullYear();
  if (h.getMonth() < d.getMonth() || (h.getMonth() === d.getMonth() && h.getDate() < d.getDate())) i--;
  return i;
}

/**
 * Dibuja o actualiza un gr√°fico Chart.js.
 */
function drawChart(id, label, data, color, type) {
  if (charts[id.replace('Chart', '')]) charts[id.replace('Chart', '')].destroy();
  
  const sortedKeys = Object.keys(data).sort((a, b) => {
    // Ordenar num√©ricamente si es por a√±o, edad o intervalo
    if (label.includes('A√±o') || label.includes('Intervalos') || label.includes('Edades')) {
      const aNum = parseInt(a.split('-')[0]);
      const bNum = parseInt(b.split('-')[0]);
      return aNum - bNum;
    }
    // Ordenar alfab√©ticamente para agrupaciones (Departamento/Provincia)
    return a.localeCompare(b);
  });
  
  const sortedData = {};
  sortedKeys.forEach(k => { sortedData[k] = data[k]; });
  
  charts[id.replace('Chart', '')] = new Chart(document.getElementById(id), {
    type: type,
    data: {
      labels: Object.keys(sortedData),
      datasets: [{
        label: label,
        data: Object.values(sortedData),
        backgroundColor: type === 'bar' ? color : 'transparent',
        borderColor: type === 'line' ? color.replace('0.7', '1') : color,
        pointBackgroundColor: type === 'line' ? color.replace('0.7', '1') : color,
        borderRadius: 6,
        fill: type === 'line' ? false : true,
        borderWidth: type === 'line' ? 2 : 1 
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Cantidad de Personas'
          }
        },
        x: {
          title: {
            display: true,
            text: label
          }
        }
      }
    }
  });
}

/**
 * Funci√≥n principal que procesa los datos cargados y actualiza todos los gr√°ficos y tablas.
 */
function calcular() {
  if (dataRows.length === 0) {
    // Limpiar gr√°ficos y tablas si no hay datos
    Object.keys(charts).forEach(key => charts[key].destroy());
    charts = {};
    document.getElementById('yearTable').innerHTML = '';
    document.getElementById('deptTable').innerHTML = '';
    crossTableHead.innerHTML = '';
    crossTableBody.innerHTML = '';
    yearlyCrossTableHead.innerHTML = '';
    yearlyCrossTableBody.innerHTML = '';
    loadingIndicator.classList.add('hidden');
    return;
  }

  const retirementYears = parseInt(inputYears.value) || 65;
  const retirementMonths = parseInt(inputMonths.value) || 0;
  // AQUI ES DONDE LEEMOS LA AGRUPACION ACTUAL
  const agrupacion = groupingType.value; // 'departamento' o 'provincia'

  const distIdade = {};
  const distAno = {};
  const distInt = {};
  const distAgrupacion = {};  
  const distCruzadaIntervalos = {}; // Cruzada 5 a√±os
  const distCruzadaAnual = {}; // Cruzada Anual (NUEVA)
  
  trabalhadoresPorAno = {};
  trabalhadoresPorAgrupacion = {};
  const anoAtual = new Date().getFullYear();
  const anoLimiteAnual = anoAtual + ANOS_PREVISAO; // A√±o l√≠mite para la tabla anual
  
  // Array para recolectar todas las claves de agrupaci√≥n encontradas
  const groupingKeys = [];

  // 1. Actualizar t√≠tulos
  const agrupacionTitle = agrupacion.charAt(0).toUpperCase() + agrupacion.slice(1);
  deptChartTitle.textContent = `üè¢ Jubilaciones por ${agrupacionTitle}`;
  deptTableTitle.textContent = `üìù Tabla: Jubilaciones por ${agrupacionTitle}`;
  deptTableHead.textContent = agrupacionTitle;
  crossTableTitle.textContent = `üóÇÔ∏è Jubilaciones por ${agrupacionTitle} vs. Intervalos de 5 a√±os`;
  yearlyCrossTableTitle.textContent = `üìÖ Jubilaciones por ${agrupacionTitle} vs. Pr√≥ximos ${ANOS_PREVISAO} A√±os`;
  agrupacionExportLabel.innerHTML = `Exportar por <span class="text-blue-600">${agrupacionTitle}</span>:`;

  dataRows.forEach(r => {
    const d = parseData(r.fechaNacimiento);
    if (!d) return;

    // B. C√°lculo de Fecha de Jubilaci√≥n (precisa)
    const fechaJubilacion = new Date(d.getTime());
    fechaJubilacion.setFullYear(fechaJubilacion.getFullYear() + retirementYears);
    fechaJubilacion.setMonth(fechaJubilacion.getMonth() + retirementMonths);

    const ano = fechaJubilacion.getFullYear();
    
    // A. C√°lculo de Edad Actual
    const i = idade(d);
    distIdade[i] = (distIdade[i] || 0) + 1;
    
    // C, D, E, F: Acumulaciones solo si la jubilaci√≥n es futura o actual
    if (ano >= anoAtual) {
        // C. Acumulaci√≥n por A√±o
        distAno[ano] = (distAno[ano] || 0) + 1;
        trabalhadoresPorAno[ano] = trabalhadoresPorAno[ano] || [];
        trabalhadoresPorAno[ano].push(r);

        // D. Acumulaci√≥n por Intervalo (5 a√±os)
        const ini = Math.floor((ano - anoAtual) / INTERVALO) * INTERVALO + anoAtual;
        let lblIntervalo = `${ini}-${ini + INTERVALO - 1}`; 
        distInt[lblIntervalo] = (distInt[lblIntervalo] || 0) + 1;
        
        // E. Obtener Clave de Agrupaci√≥n (AQUI EST√Å LA CORRECCI√ìN CLAVE)
        let name;
        let id;

        if (agrupacion === 'departamento') {
          name = r.departamento;
          id = r.departamentoID;
        } else if (agrupacion === 'provincia') {
          name = r.provincia;
          id = r.provinciaID;
        }
        
        if (name) {
          const key = `${id ? id + ' - ' : ''}${name}`;
          
          if (!groupingKeys.includes(key)) { groupingKeys.push(key); } // Recolectar clave
          
          distAgrupacion[key] = (distAgrupacion[key] || 0) + 1;
          
          trabalhadoresPorAgrupacion[key] = trabalhadoresPorAgrupacion[key] || [];
          trabalhadoresPorAgrupacion[key].push(r);

          // F. Acumulaci√≥n Cruzada - Intervalos
          if (lblIntervalo) {
            distCruzadaIntervalos[key] = distCruzadaIntervalos[key] || {};
            distCruzadaIntervalos[key][lblIntervalo] = (distCruzadaIntervalos[key][lblIntervalo] || 0) + 1;
          }
          
          // G. Acumulaci√≥n Cruzada - Anual (NUEVA)
          if (ano < anoLimiteAnual) {
            distCruzadaAnual[key] = distCruzadaAnual[key] || {};
            distCruzadaAnual[key][ano] = (distCruzadaAnual[key][ano] || 0) + 1;
          }
        }
    }
  });

  // Ordenar Claves de Intervalos y Agrupaci√≥n
  const sortedIntervals = Object.keys(distInt).sort((a, b) => parseInt(a.split('-')[0]) - parseInt(b.split('-')[0]));
  groupingKeys.sort(); // Ordenar las claves de agrupaci√≥n (Departamento/Provincia)

  // 2. Dibujar Gr√°ficos
  drawChart('ageChart', 'Edades', distIdade, 'rgba(59,130,246,0.7)', document.getElementById('chartTypeAge').value);
  drawChart('retirementChart', 'A√±o de Jubilaci√≥n', distAno, 'rgba(16,185,129,0.7)', document.getElementById('chartTypeRetirement').value);
  drawChart('intervalChart', 'Intervalos 5 a√±os', distInt, 'rgba(234,179,8,0.7)', document.getElementById('chartTypeInterval').value);
  drawChart('deptChart', agrupacionTitle, distAgrupacion, 'rgba(220,38,38,0.7)', document.getElementById('chartTypeDept').value);

  // 3. Rellenar Tablas Simples
  document.getElementById('yearTable').innerHTML = Object.keys(distAno).sort((a,b)=>parseInt(a)-parseInt(b)).map(a => `<tr><td class='border px-3 py-2 text-center'>${a}</td><td class='border px-3 py-2 text-center font-semibold'>${distAno[a]}</td></tr>`).join('');
  
  document.getElementById('deptTable').innerHTML = Object.keys(distAgrupacion).sort().map(d => `<tr><td class='border px-3 py-2 text-left'>${d}</td><td class='border px-3 py-2 text-center font-semibold'>${distAgrupacion[d]}</td></tr>`).join('');
  
  // 4. Rellenar Tabla Cruzada de Intervalos (5 a√±os)
  renderCrossTable(distCruzadaIntervalos, sortedIntervals, groupingKeys, crossTableHead, crossTableBody, agrupacionTitle, false);
  
  // 5. Rellenar **NUEVA** Tabla Cruzada Anual (Pr√≥ximos 10 a√±os)
  const yearlyKeys = [];
  for(let y = anoAtual; y < anoLimiteAnual; y++) { yearlyKeys.push(y); }
  renderCrossTable(distCruzadaAnual, yearlyKeys.map(String), groupingKeys, yearlyCrossTableHead, yearlyCrossTableBody, agrupacionTitle, true);
  
  // 6. Rellenar Selectores de Exportaci√≥n
  yearSelect.innerHTML = Object.keys(trabalhadoresPorAno).sort((a,b)=>parseInt(a)-parseInt(b)).map(y => `<option value='${y}'>${y}</option>`).join('');
  agrupacionSelect.innerHTML = Object.keys(trabalhadoresPorAgrupacion).sort().map(g => `<option value='${g}'>${g}</option>`).join('');

  // 7. Ocultar indicador de carga
  if (dataRows.length > 0) {
      loadingIndicator.classList.add('hidden');
      fileLoadedMessage.classList.remove('hidden');
  }
}

/**
 * Funci√≥n gen√©rica para renderizar tablas cruzadas.
 */
function renderCrossTable(data, columns, rows, headElement, bodyElement, rowTitle, isYearly) {
  // Crear encabezado
  const totalBg = isYearly ? 'bg-indigo-300' : 'bg-gray-300';
  let headHtml = `<th class="border px-3 py-2 sticky left-0 bg-gray-200">${rowTitle}</th>`;
  columns.forEach(col => {
    headHtml += `<th class="border px-3 py-2">${col}</th>`;
  });
  headHtml += `<th class="border px-3 py-2 ${totalBg} font-bold">Total</th>`;
  headElement.innerHTML = headHtml;

  // Crear cuerpo
  let bodyHtml = '';
  let grandTotal = 0;
  rows.forEach(key => {
    let rowTotal = 0;
    let rowHtml = `<tr><td class="border px-3 py-2 font-medium text-left sticky left-0">${key}</td>`;
    
    columns.forEach(col => {
      const count = data[key] ? (data[key][col] || 0) : 0;
      rowHtml += `<td class="border px-3 py-2">${count}</td>`;
      rowTotal += count;
    });
    grandTotal += rowTotal;
    rowHtml += `<td class="border px-3 py-2 ${isYearly ? 'bg-indigo-100' : 'bg-gray-100'} font-bold">${rowTotal}</td></tr>`;
    bodyHtml += rowHtml;
  });

  // Fila de totales de columna
  const footerBg = isYearly ? 'bg-indigo-400 text-white' : 'bg-gray-200';
  let footerHtml = `<tr class="${footerBg} font-bold"><td class="border px-3 py-2 text-left sticky left-0">Total Columna</td>`;
  columns.forEach(col => {
    let colTotal = rows.reduce((sum, key) => sum + (data[key] ? (data[key][col] || 0) : 0), 0);
    footerHtml += `<td class="border px-3 py-2">${colTotal}</td>`;
  });
  footerHtml += `<td class="border px-3 py-2 ${totalBg}">${grandTotal}</td></tr>`;
  bodyHtml += footerHtml;
  
  bodyElement.innerHTML = bodyHtml;
}


async function handleFile(file) {
  if (!file) return;

  fileLoadedMessage.classList.add('hidden');
  loadingIndicator.classList.remove('hidden');
  loadingMessage.textContent = `Analizando archivo "${file.name}"...`;
  progressBar.style.width = '10%';  

  if (file.size > 5 * 1024 * 1024) {
    if (!confirm(`El archivo "${file.name}" es grande (${(file.size / (1024 * 1024)).toFixed(2)} MB). ¬øDesea continuar? Podr√≠a tardar unos segundos.`)) {
      loadingIndicator.classList.add('hidden');
      return;
    }
  }

  await new Promise(resolve => setTimeout(resolve, 500));  
  
  const reader = new FileReader();
  
  reader.onprogress = (event) => {
    if (event.lengthComputable) {
      const percent = Math.round((event.loaded / event.total) * 90) + 10;
      progressBar.style.width = `${percent}%`;
    }
  };

  reader.onload = async (ev) => {
    loadingMessage.textContent = 'Procesando datos en memoria...';
    progressBar.style.width = '100%';  

    try {
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      
      if (!rows.length) {
        alert("El archivo Excel est√° vac√≠o o la primera hoja no contiene datos.");
        loadingIndicator.classList.add('hidden');
        return;
      }
      
      const h = Object.keys(rows[0]).map(x => x.toLowerCase().trim());
      
      const findColumn = (keywords) => {
        for (const keyword of keywords) {
          const foundLower = h.find(x => x.includes(keyword));
          if (foundLower) {
             return Object.keys(rows[0]).find(k => k.toLowerCase().trim() === foundLower);
          }
        }
        return null;
      };

      const colN = findColumn(['nascimento', 'nacimiento', 'birth', 'fecha']);
      const colD = findColumn(['departamento', 'dept', 'dep']);
      const colDId = findColumn(['departamento id', 'depart id', 'dept id']);
      const colP = findColumn(['provincia', 'province', 'estado']);
      const colPId = findColumn(['provincia id', 'province id', 'estado id']);
      
      if (!colN) {
        alert("üö® Error: No se encontr√≥ la columna de Fecha de Nacimiento (buscamos 'nacimiento', 'nascimento', 'birth' o 'fecha' en los encabezados).");
        loadingIndicator.classList.add('hidden');
        return;
      }
      
      dataRows = rows.map(r => ({
        fechaNacimiento: r[colN],
        departamento: r[colD],
        departamentoID: r[colDId],
        provincia: r[colP],
        provinciaID: r[colPId],
        full: r
      }));
      
      calcular();
    } catch (e) {
      alert(`üö® Error al procesar el archivo: ${e.message}`);
      console.error(e);
      loadingIndicator.classList.add('hidden');
    }
  };

  reader.onerror = (e) => {
    alert(`üö® Error de lectura: ${e.target.error}`);
    loadingIndicator.classList.add('hidden');
  };

  reader.readAsArrayBuffer(file);
}

// --- Event Listeners ---
fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });
dropArea.addEventListener('click', () => fileInput.click());
dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('bg-blue-100', 'border-blue-600'); });
dropArea.addEventListener('dragleave', e => { e.preventDefault(); dropArea.classList.remove('bg-blue-100', 'border-blue-600'); });
dropArea.addEventListener('drop', e => { e.preventDefault(); dropArea.classList.remove('bg-blue-100', 'border-blue-600'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });

['chartTypeAge', 'chartTypeRetirement', 'chartTypeInterval', 'chartTypeDept', 'inputYears', 'inputMonths', 'groupingType'].forEach(id => {
  document.getElementById(id).addEventListener('change', calcular);
});

// Exportaci√≥n PNG
document.querySelectorAll('[data-chart-id]').forEach(button => {
    button.onclick = () => {
      const chartKey = button.getAttribute('data-chart-id').replace('Chart', '');
      const chartObj = charts[chartKey];
      if (chartObj) {
          const a = document.createElement('a');
          a.href = chartObj.toBase64Image('image/png', 1.0);
          const titleElement = document.getElementById(button.getAttribute('data-chart-id')).closest('.flex-col').querySelector('h2');
          const title = titleElement ? titleElement.textContent.trim().replace(/[^a-z0-9\s]/gi, '') : chartKey;
          a.download = `${title.replace(/\s+/g, '_')}.png`;
          a.click();
      } else {
          alert('El gr√°fico no est√° inicializado.');
      }
    };
});

// Exportaci√≥n Excel por A√±o
exportBtn.onclick = () => {
  const ano = yearSelect.value;
  if (!ano || !trabalhadoresPorAno[ano]) {
    alert('Seleccione un a√±o v√°lido para exportar.');
    return;
  }
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(trabalhadoresPorAno[ano].map(r => r.full));
  XLSX.utils.book_append_sheet(wb, ws, `Jubilaciones_${ano}`);
  XLSX.writeFile(wb, `jubilaciones_por_a√±o_${ano}.xlsx`);
};

// Exportaci√≥n Excel por Agrupaci√≥n
exportAgrupacionBtn.onclick = () => {
  const key = agrupacionSelect.value;
  const agrupacion = groupingType.value;
  
  if (!key || !trabalhadoresPorAgrupacion[key]) {
    alert(`Seleccione una Agrupaci√≥n v√°lida para exportar.`);
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(trabalhadoresPorAgrupacion[key].map(r => r.full));
  const sheetName = key.replace(/[\[\]\/\?\*\\:;]/g, ' ').substring(0, 31).trim(); 
  
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, `jubilaciones_por_${agrupacion}_${key.replace(/[^a-z0-9]/gi, '_')}.xlsx`);
};

// Exportaci√≥n PDF del Dashboard
exportPDF.onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  let first = true;
  const groupingLabel = groupingType.value === 'departamento' ? 'Departamento' : 'Provincia';
  let y = 15;
  
  const chartInfo = [
    ['ageChart', 'Distribuci√≥n de Edades'],
    ['retirementChart', 'Jubilaciones por A√±o'],
    ['intervalChart', 'Jubilaciones en Intervalos de 5 a√±os'],
    ['deptChart', `Jubilaciones por ${groupingLabel}`]
  ];
  
  const addText = (text, size, align) => {
    doc.setFontSize(size);
    doc.text(text, 105, y, { align: align });
    y += size * 0.7 * 0.352778;
  };
  
  const addChart = (id, title) => {
    const chartKey = id.replace('Chart', '');
    const chartObj = charts[chartKey];
    
    if (!first) y += 5; 
    if (y > 270) { 
        doc.addPage(); 
        y = 15; 
    }
    
    addText(title, 14, 'center');
    
    if (chartObj) {
        const chartImg = chartObj.toBase64Image('image/png', 1.0);
        const imgWidth = 180;
        const imgHeight = 90;
        
        doc.addImage(chartImg, 'PNG', 15, y, imgWidth, imgHeight);
        y += imgHeight + 5; 
    } else {
        addText(`Gr√°fico "${title}" no disponible.`, 10, 'center');
        y += 5;
    }
    first = false;
  };

  addText(`Dashboard de Jubilaciones (Jubilaci√≥n a los ${inputYears.value} a√±os y ${inputMonths.value} meses)`, 20, 'center');
  y += 5;

  chartInfo.forEach(([id, title]) => addChart(id, title));
  
  // Funci√≥n para agregar la tabla al PDF
  const addTableToPDF = (title, headElement, bodyElement, totalRowBgColor) => {
      if (y > 250) { doc.addPage(); y = 15; }
      addText(title, 14, 'center');
      
      const head = [Array.from(headElement.querySelectorAll('th')).map(t => t.textContent.trim())];
      const allRows = bodyElement.querySelectorAll('tr');
      const bodyData = Array.from(allRows).slice(0, -1).map(row => Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim()));
      const totalRow = Array.from(allRows).slice(-1).map(row => Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim()));
      
      doc.autoTable({
          startY: y,
          head: head,
          body: bodyData,
          foot: totalRow,
          theme: 'grid',
          headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: 'bold' },
          footStyles: { fillColor: totalRowBgColor, textColor: [255, 255, 255], fontStyle: 'bold' },
          styles: { fontSize: 8, cellPadding: 1, overflow: 'linebreak' },
          columnStyles: { 
              0: { fontStyle: 'bold', halign: 'left' }
          },
          didDrawPage: (data) => {
               y = data.cursor.y;
          }
      });
  };

  // 1. Tabla Anual de 10 A√±os (NUEVA)
  addTableToPDF(`Tabla: Jubilaciones por ${groupingLabel} vs. Pr√≥ximos 10 A√±os`, yearlyCrossTableHead, yearlyCrossTableBody, [79, 70, 229]); // Color √çndigo

  // 2. Tabla de Intervalos de 5 A√±os
  addTableToPDF(`Tabla: Jubilaciones por ${groupingLabel} vs. Intervalos de 5 a√±os`, crossTableHead, crossTableBody, [150, 150, 150]); // Color Gris


  doc.save('dashboard_jubilaciones_completo.pdf');
};
</script>

</body>
</html>